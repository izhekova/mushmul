#!/bin/bash

yum install puppet3 -y

touch /etc/default/puppet

cat <<EOF > /etc/default/puppet
# Start puppet on boot?
START=yes
EOF

cat <<EOF > /etc/init.d/preconfigure.sh
#!/bin/bash
IPV4="\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/local-ipv4\`"
HOSTNAME="\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/hostname\`"
echo "\$IPV4 \$HOSTNAME" >> /etc/hosts
hostname \$HOSTNAME
EOF
chmod +x /etc/init.d/preconfigure.sh
ln -s /etc/init.d/preconfigure.sh /etc/rc6.d/K96preconfigure

cat <<EOF > /etc/init.d/cleanup.sh
#!/bin/bash 
IPV4="\`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/local-ipv4\`"
sed -i "/\$IPV4/d" /etc/hosts
rm -rf /var/lib/puppet/ssl/
EOF
chmod +x /etc/init.d/cleanup.sh
ln -s /etc/init.d/cleanup.sh /etc/rc6.d/K96cleanup

echo "10.28.0.120	dbkeuwprod-puppet.debijenkorf.nl puppet" >> /etc/hosts

IP=`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/local-ipv4`
HOSTNAME=`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/hostname`
echo "$IP $HOSTNAME" >> /etc/hosts

hostname $HOSTNAME  

cat <<EOF > /etc/puppet/puppet.conf
[main]
    logdir = /var/log/puppet
    rundir = /var/run/puppet
    ssldir = \$vardir/ssl
[agent]
    server = dbkeuwprod-puppet.debijenkorf.nl
    classfile = \$vardir/classes.txt
    localconfig = \$vardir/localconfig
    basemodulepath = \$confdir/modules:\$confdir/environments/\$environmentpath/modules
    environment = dbkaws
    ordering = manifest
EOF

/etc/init.d/puppet start
